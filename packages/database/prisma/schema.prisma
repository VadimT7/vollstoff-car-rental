generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  emailVerified    DateTime?
  name             String?
  phone            String?
  image            String?
  dateOfBirth      DateTime?
  licenseNumber    String?
  licenseExpiry    DateTime?
  licenseImageUrl  String?
  licenseVerified  Boolean         @default(false)
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  postalCode       String?
  country          String?
  role             Role            @default(CUSTOMER)
  status           UserStatus      @default(ACTIVE)
  isVerified       Boolean         @default(false)
  acceptedTermsAt  DateTime?
  stripeCustomerId String?         @unique
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  accounts         Account[]
  bookings         Booking[]
  notifications    Notification[]
  paymentMethods   PaymentMethod[]
  sessions         Session[]

  @@index([email])
  @@index([status])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Car {
  id              String           @id @default(cuid())
  slug            String           @unique
  make            String
  model           String
  year            Int
  trim            String?
  vin             String?
  licensePlate    String?
  displayName     String
  description     String
  featured        Boolean          @default(false)
  featuredOrder   Int?
  status          CarStatus        @default(ACTIVE)
  category        CarCategory
  bodyType        BodyType
  transmission    TransmissionType
  fuelType        FuelType
  drivetrain      DrivetrainType
  seats           Int
  doors           Int
  engineSize      Float?
  engineType      String?
  horsePower      Int?
  torque          Int?
  topSpeed        Int?
  acceleration    Float?
  fuelConsumption Float?
  features        Json
  primaryImageUrl String?
  threeDModelUrl  String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  availability    Availability[]
  bookings        Booking[]
  images          CarImage[]
  maintenance     Maintenance[]
  priceRules      PriceRule[]

  @@index([status])
  @@index([category])
  @@index([featured])
}

model CarImage {
  id        String   @id @default(cuid())
  carId     String
  url       String
  alt       String?
  caption   String?
  order     Int      @default(0)
  isGallery Boolean  @default(true)
  createdAt DateTime @default(now())
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
}

model PriceRule {
  id                String         @id @default(cuid())
  carId             String
  basePricePerDay   Decimal        @db.Decimal(10, 2)
  currency          String         @default("EUR")
  weekendMultiplier Decimal        @default(1.0) @db.Decimal(3, 2)
  weeklyDiscount    Decimal        @default(0.0) @db.Decimal(3, 2)
  monthlyDiscount   Decimal        @default(0.0) @db.Decimal(3, 2)
  minimumDays       Int            @default(1)
  maximumDays       Int?
  includedKmPerDay  Int            @default(200)
  extraKmPrice      Decimal        @db.Decimal(10, 2)
  depositAmount     Decimal        @db.Decimal(10, 2)
  validFrom         DateTime       @default(now())
  validUntil        DateTime?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  car               Car            @relation(fields: [carId], references: [id], onDelete: Cascade)
  seasonalRates     SeasonalRate[]

  @@index([carId])
  @@index([isActive])
}

model SeasonalRate {
  id          String    @id @default(cuid())
  priceRuleId String
  name        String
  startDate   DateTime
  endDate     DateTime
  multiplier  Decimal   @db.Decimal(3, 2)
  priceRule   PriceRule @relation(fields: [priceRuleId], references: [id], onDelete: Cascade)

  @@index([priceRuleId])
  @@index([startDate, endDate])
}

model AddOn {
  id               String         @id @default(cuid())
  slug             String         @unique
  name             String
  description      String?
  category         AddOnCategory
  priceType        PriceType
  price            Decimal        @db.Decimal(10, 2)
  currency         String         @default("EUR")
  icon             String?
  imageUrl         String?
  order            Int            @default(0)
  maxQuantity      Int?
  requiresApproval Boolean        @default(false)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  bookingAddOns    BookingAddOn[]

  @@index([isActive])
  @@index([category])
}

model Booking {
  id              String         @id @default(cuid())
  bookingNumber   String         @unique
  userId          String
  guestEmail      String?
  guestName       String?
  guestPhone      String?
  carId           String
  startDate       DateTime
  endDate         DateTime
  pickupType      PickupType
  returnType      PickupType
  pickupLocation  String?
  returnLocation  String?
  deliveryAddress String?
  deliveryFee     Decimal?       @db.Decimal(10, 2)
  basePriceTotal  Decimal        @db.Decimal(10, 2)
  addOnsTotal     Decimal        @default(0) @db.Decimal(10, 2)
  feesTotal       Decimal        @default(0) @db.Decimal(10, 2)
  taxTotal        Decimal        @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal        @db.Decimal(10, 2)
  currency        String         @default("EUR")
  status          BookingStatus  @default(PENDING)
  paymentStatus   PaymentStatus  @default(PENDING)
  includedKm      Int
  startMileage    Int?
  endMileage      Int?
  extraKmCharge   Decimal?       @db.Decimal(10, 2)
  customerNotes   String?
  internalNotes   String?
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  guestLicense    String?
  car             Car            @relation(fields: [carId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
  addOns          BookingAddOn[]
  contract        Contract?
  damageReport    DamageReport?
  notifications   Notification[]
  payments        Payment[]

  @@index([userId])
  @@index([carId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([bookingNumber])
}

model BookingAddOn {
  id         String  @id @default(cuid())
  bookingId  String
  addOnId    String
  quantity   Int     @default(1)
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  addOn      AddOn   @relation(fields: [addOnId], references: [id])
  booking    Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([bookingId, addOnId])
}

model Payment {
  id                    String                   @id @default(cuid())
  bookingId             String
  stripePaymentIntentId String?                  @unique
  stripeChargeId        String?
  stripeRefundId        String?
  amount                Decimal                  @db.Decimal(10, 2)
  currency              String                   @default("EUR")
  type                  PaymentType
  method                PaymentMethodType
  status                PaymentTransactionStatus
  description           String?
  metadata              Json?
  failureReason         String?
  processedAt           DateTime?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  booking               Booking                  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String
  stripePaymentMethodId String   @unique
  type                  String
  card                  Json?
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Availability {
  id          String   @id @default(cuid())
  carId       String
  date        DateTime @db.Date
  isAvailable Boolean  @default(true)
  reason      String?
  car         Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([carId, date])
  @@index([carId])
  @@index([date])
}

model Maintenance {
  id            String          @id @default(cuid())
  carId         String
  type          MaintenanceType
  description   String
  scheduledDate DateTime
  completedDate DateTime?
  cost          Decimal?        @db.Decimal(10, 2)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  car           Car             @relation(fields: [carId], references: [id])

  @@index([carId])
  @@index([scheduledDate])
}

model Contract {
  id           String    @id @default(cuid())
  bookingId    String    @unique
  documentUrl  String
  signedAt     DateTime?
  signerName   String?
  signerEmail  String?
  signatureUrl String?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime  @default(now())
  booking      Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model DamageReport {
  id                   String    @id @default(cuid())
  bookingId            String    @unique
  preInspectionNotes   String?
  preInspectionPhotos  Json?
  preInspectionDate    DateTime?
  postInspectionNotes  String?
  postInspectionPhotos Json?
  postInspectionDate   DateTime?
  damageDescription    String?
  estimatedCost        Decimal?  @db.Decimal(10, 2)
  chargedAmount        Decimal?  @db.Decimal(10, 2)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  booking              Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model Notification {
  id            String              @id @default(cuid())
  userId        String?
  bookingId     String?
  channel       NotificationChannel
  type          NotificationType
  subject       String?
  content       String
  metadata      Json?
  status        NotificationStatus  @default(PENDING)
  sentAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  createdAt     DateTime            @default(now())
  booking       Booking?            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user          User?               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookingId])
  @@index([status])
}

model Testimonial {
  id          String    @id @default(cuid())
  authorName  String
  authorTitle String?
  authorImage String?
  content     String
  rating      Int       @default(5)
  carModel    String?
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isPublished])
}

model Coupon {
  id               String       @id @default(cuid())
  code             String       @unique
  description      String?
  discountType     DiscountType
  discountValue    Decimal      @db.Decimal(10, 2)
  minimumAmount    Decimal?     @db.Decimal(10, 2)
  maximumDiscount  Decimal?     @db.Decimal(10, 2)
  usageLimit       Int?
  usageCount       Int          @default(0)
  validFrom        DateTime
  validUntil       DateTime
  isActive         Boolean      @default(true)
  applicableCarIds String[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([code])
  @@index([isActive])
}

enum Role {
  CUSTOMER
  STAFF
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum CarStatus {
  ACTIVE
  MAINTENANCE
  RETIRED
  COMING_SOON
}

enum CarCategory {
  LUXURY
  SPORT
  SUPERCAR
  SUV
  CONVERTIBLE
  ELECTRIC
}

enum BodyType {
  SEDAN
  COUPE
  CONVERTIBLE
  SUV
  HATCHBACK
  WAGON
}

enum TransmissionType {
  MANUAL
  AUTOMATIC
  SEMI_AUTOMATIC
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
  PLUG_IN_HYBRID
}

enum DrivetrainType {
  FWD
  RWD
  AWD
  FOUR_WD
}

enum AddOnCategory {
  INSURANCE
  EQUIPMENT
  SERVICE
  EXPERIENCE
}

enum PriceType {
  PER_DAY
  PER_BOOKING
  PER_KM
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
}

enum PickupType {
  SHOWROOM
  DELIVERY
}

enum PaymentType {
  DEPOSIT
  RENTAL_FEE
  EXTRA_CHARGE
  REFUND
  DAMAGE_CHARGE
}

enum PaymentMethodType {
  CARD
  CASH
  BANK_TRANSFER
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum MaintenanceType {
  ROUTINE
  REPAIR
  INSPECTION
  CLEANING
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  IN_APP
}

enum NotificationType {
  BOOKING_CONFIRMATION
  BOOKING_REMINDER
  PAYMENT_RECEIPT
  PICKUP_REMINDER
  RETURN_REMINDER
  MARKETING
  SYSTEM
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}
